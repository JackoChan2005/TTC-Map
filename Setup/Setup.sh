#!/bin/bash
set -e

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# TTC-Map â€” Full Environment Setup (macOS/Linux/WSL/Git-Bash)
# Run:
#   bash setup/setup.sh
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Project root = parent of this script's directory
PROJECT_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
echo "ğŸ“‚ Project root: $PROJECT_ROOT"

REQ_FILE="$PROJECT_ROOT/requirements.txt"
VENV_DIR="$PROJECT_ROOT/venv"
VENV_PY="$VENV_DIR/bin/python"
API_DIR="$PROJECT_ROOT/API"

# â”€â”€ 1. Fix requirements.txt encoding (UTF-16 â†’ UTF-8) â”€â”€
echo ""
echo "ğŸ”§ Fixing requirements.txt encoding..."

if [ -f "$REQ_FILE" ]; then
  if file "$REQ_FILE" | grep -qi "utf-16\|bom"; then
    iconv -f UTF-16 -t UTF-8 "$REQ_FILE" \
      | sed 's/\r//g' | grep -v '^\s*$' > "$PROJECT_ROOT/requirements_fixed.txt"
    mv "$PROJECT_ROOT/requirements_fixed.txt" "$REQ_FILE"
    echo "   âœ… Converted to UTF-8"
  else
    # Still normalize CRLF and remove empty lines, keep as UTF-8
    sed 's/\r//g' "$REQ_FILE" | grep -v '^\s*$' > "$PROJECT_ROOT/requirements_fixed.txt"
    mv "$PROJECT_ROOT/requirements_fixed.txt" "$REQ_FILE"
    echo "   âœ… Already UTF-8 (normalized line endings)"
  fi
else
  echo "   âš  requirements.txt not found (will be generated by pipreqs)"
fi

# â”€â”€ 2. Python virtual environment â”€â”€
echo ""
echo "ğŸ Setting up Python virtual environment..."

if [ ! -d "$VENV_DIR" ]; then
  python3 -m venv "$VENV_DIR"
  echo "   âœ… venv created"
else
  echo "   âœ… venv already exists"
fi

echo "ğŸ“¦ Upgrading pip and installing pipreqs..."
"$VENV_PY" -m pip install --upgrade pip
"$VENV_PY" -m pip install pipreqs

echo "ğŸ” Scanning Python files for imports with pipreqs..."
"$VENV_PY" -m pipreqs "$API_DIR" --force --savepath "$REQ_FILE"
if grep -q "^fastapi$" "$REQ_FILE"; then
  sed -i.bak 's/^fastapi$/fastapi[standard]/' "$REQ_FILE"
  rm -f "$REQ_FILE.bak"
fi
echo "   âœ… requirements.txt updated from source scan:"
cat "$REQ_FILE"

echo ""
echo "ğŸ“¦ Installing Python dependencies..."
"$VENV_PY" -m pip install -r "$REQ_FILE"
echo "   âœ… Python packages installed"

# â”€â”€ 3. Node.js dependencies â”€â”€
echo ""
echo "ğŸ“¦ Installing Node.js dependencies..."
cd "$PROJECT_ROOT/node-api"
npm ci
echo "   âœ… Node packages installed"

# â”€â”€ 4. Summary â”€â”€
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ…  Setup complete!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "  PYTHON API (FastAPI):"
echo "    Activate venv:   source venv/bin/activate"
echo "    Init DB:         cd API/src && python update_db.py"
echo "    Run server:      fastapi dev API/src/main.py"
echo ""
echo "  NODE API (Express):"
echo "    Start server:    cd node-api && npm start"
echo "    Dev mode:        cd node-api && npm run dev"
echo "    Frontend:        http://localhost:3000"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
